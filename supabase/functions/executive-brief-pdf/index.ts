import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

type TopicGroup = "research" | "industry" | "policy";

interface BriefItem {
  id: string;
  title: string;
  source: string;
  url: string;
  publishedAt: string;
  tag: "Tech" | "Policy" | "Research" | "Industry" | "Risk";
  summary: string;
  impact: string;
  importanceScore: number;
  topicGroup: TopicGroup;
}

interface ExecutiveBrief {
  generatedAt: string;
  timeRange: string;
  items: BriefItem[];
  rejectedCount: number;
  sourcesUsed: string[];
  groupedItems: Record<TopicGroup, BriefItem[]>;
}

const TOPIC_CONFIG: Record<TopicGroup, { title: string; emoji: string }> = {
  research: { title: "Major Research Breakthroughs", emoji: "ðŸš€" },
  industry: { title: "Industry News & Releases", emoji: "ðŸ¢" },
  policy: { title: "Policy & Safety", emoji: "âš–ï¸" }
};

// Generate simple HTML that can be converted to PDF
function generatePDFHTML(brief: ExecutiveBrief): string {
  const formatDate = (dateStr: string) => {
    try {
      return new Date(dateStr).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    } catch {
      return dateStr;
    }
  };

  // Generate grouped sections
  const groupOrder: TopicGroup[] = ["research", "industry", "policy"];
  const sectionsHTML = groupOrder.map(group => {
    const items = brief.groupedItems?.[group] || [];
    if (items.length === 0) return '';
    
    const config = TOPIC_CONFIG[group];
    const itemsHTML = items.map((item, index) => `
      <div style="margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #eee;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
          <span style="background: ${getTagColor(item.tag)}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">${item.tag}</span>
          <span style="background: #1a1a2e; color: #ffd700; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700;">[Score: ${item.importanceScore}/10]</span>
          <span style="color: #666; font-size: 11px;">${item.source} Â· ${formatDate(item.publishedAt)}</span>
        </div>
        <h4 style="margin: 0 0 6px 0; font-size: 14px; font-weight: 600; color: #111;">${item.title}</h4>
        <p style="margin: 0 0 6px 0; font-size: 13px; color: #333; line-height: 1.5;">${item.summary}</p>
        <p style="margin: 0; font-size: 12px; color: #666; font-style: italic;">ðŸ’¡ ${item.impact}</p>
      </div>
    `).join('');

    return `
      <div style="margin-bottom: 32px;">
        <h2 style="font-size: 18px; font-weight: 700; color: #111; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid ${getSectionColor(group)};">
          ${config.emoji} ${config.title}
        </h2>
        ${itemsHTML}
      </div>
    `;
  }).join('');

  return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>AI Research & News Brief - ${brief.timeRange}</title>
  <style>
    @page {
      margin: 0.75in;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.6;
      color: #111;
      max-width: 800px;
      margin: 0 auto;
      padding: 40px;
    }
    .header {
      text-align: center;
      margin-bottom: 32px;
      padding-bottom: 20px;
      border-bottom: 3px solid #111;
    }
    .header h1 {
      margin: 0 0 8px 0;
      font-size: 26px;
      font-weight: 700;
    }
    .header p {
      margin: 0;
      color: #666;
      font-size: 14px;
    }
    .meta {
      display: flex;
      justify-content: space-between;
      margin-bottom: 28px;
      padding: 12px 16px;
      background: #f5f5f5;
      border-radius: 8px;
      font-size: 12px;
    }
    .footer {
      margin-top: 32px;
      padding-top: 20px;
      border-top: 1px solid #e5e5e5;
      text-align: center;
      font-size: 11px;
      color: #999;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>AI Research & News Brief</h1>
    <p>Intelligence Report for Executive Leadership</p>
  </div>
  
  <div class="meta">
    <span><strong>Period:</strong> ${brief.timeRange}</span>
    <span><strong>Generated:</strong> ${formatDate(brief.generatedAt)}</span>
    <span><strong>Articles:</strong> ${brief.items.length}</span>
    <span><strong>Filtered:</strong> ${brief.rejectedCount} low-quality</span>
  </div>
  
  ${sectionsHTML}
  
  <div class="footer">
    <p>Generated by Oxford Intelligence</p>
    <p>Sources: ${brief.sourcesUsed.slice(0, 6).join(', ')}${brief.sourcesUsed.length > 6 ? ` and ${brief.sourcesUsed.length - 6} more` : ''}</p>
  </div>
</body>
</html>
  `;
}

function getTagColor(tag: string): string {
  switch (tag) {
    case "Tech": return "#0066cc";
    case "Policy": return "#7c3aed";
    case "Research": return "#059669";
    case "Industry": return "#d97706";
    case "Risk": return "#dc2626";
    default: return "#6b7280";
  }
}

function getSectionColor(group: TopicGroup): string {
  switch (group) {
    case "research": return "#059669";
    case "industry": return "#0066cc";
    case "policy": return "#7c3aed";
    default: return "#6b7280";
  }
}

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { brief } = await req.json() as { brief: ExecutiveBrief };
    
    if (!brief || !brief.items) {
      throw new Error("Invalid brief data");
    }
    
    const html = generatePDFHTML(brief);
    
    return new Response(html, {
      headers: {
        ...corsHeaders,
        "Content-Type": "text/html; charset=utf-8",
        "Content-Disposition": `attachment; filename="ai_research_and_news_${new Date().toISOString().split('T')[0]}.html"`,
      },
    });
    
  } catch (error) {
    console.error("PDF generation error:", error);
    return new Response(
      JSON.stringify({ error: error instanceof Error ? error.message : "Unknown error" }),
      {
        status: 500,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      }
    );
  }
});
